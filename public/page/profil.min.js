/*!
 * CirebonWeb (https://cirebonweb.com)
 * Copyright (c) 2023 CirebonWeb
 * Licensed under MIT (https://opensource.org/licenses/MIT)
 */

$(function () {
    // Referensi elemen-elemen jQuery
    const $sesiPaginationContainer = $('#sesi-pagination-container');
    let $sesiForm = $('#sesi-form'),
        $btnHapusSesi = $('#btn-hapus-sesi'),
        $btnSpinner = $btnHapusSesi.find('.spinner-border'),
        $btnText = $btnHapusSesi.find('.btn-text'),
        $sesiListContainer = $('#sesi-list-container');

    // ====================================================================
    // FUNGSI UTAMA - SEKARANG MENERIMA NOMOR HALAMAN
    // ====================================================================
    function loadPerangkat(page = 1) {

        $btnHapusSesi.prop('disabled', true);
        $btnSpinner.show();
        $btnText.text('Memuat...');
        $sesiListContainer.html('<p class="text-center">Mengambil data perangkat...</p>');
        $sesiPaginationContainer.empty(); // Kosongkan paginasi saat loading

        setTimeout(function () {
            $.ajax({
                url: `${$urlGetPerangkat}?page=${page}`, // Kirim nomor halaman sebagai parameter URL
                type: 'GET',
                dataType: 'json',
            })
                .done(function (data) {
                    setTimeout(function () {
                        $sesiListContainer.empty();
                        // Gunakan data.sessions untuk list
                        if (data.sessions && data.sessions.length > 0) {
                            let htmlContent = '<div class="row">';
                            data.sessions.forEach(s => {
                                htmlContent += `
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="bi ${s.device} ${s.warna}" style="font-size: 65px; line-height: 1"></i>
                                        <div>
                                            <i class="bi ${s.ikon}"></i> ${escapeHtml(s.os)} - ${escapeHtml(s.browser)} <br>
                                            <i class="bi ${s.ikon}"></i> ${escapeHtml(s.ip_publik)} <br>
                                            <i class="bi ${s.remember}"></i> Ingat saya
                                        </div>
                                    </div>
                                    <div class="mt-1 mb-4"> ${s.status}</div>
                                </div>`;
                            });
                            htmlContent += '</div>';
                            $sesiListContainer.html(htmlContent);

                            // Tampilkan link paginasi
                            $sesiPaginationContainer.html(data.pager);

                            // Gunakan data.total untuk logika tombol
                            if (data.total <= 1) {
                                $btnHapusSesi.prop('disabled', true);
                                $btnText.text('Hanya 1 perangkat aktif');
                            } else {
                                $btnHapusSesi.prop('disabled', false);
                                $btnText.text('Keluar dari perangkat lain');
                            }
                        } else {
                            $sesiListContainer.html('<p class="text-muted">Tidak ada perangkat aktif.</p>');
                            $btnHapusSesi.prop('disabled', true);
                            $btnText.text('Tidak ada perangkat lain');
                        }
                    }, 500);
                })
                .fail(function () {
                    $sesiListContainer.html('<p class="text-danger">Gagal memuat daftar perangkat.</p>');
                    $btnText.text('Gagal Memuat');
                })
                .always(function () {
                    // Sembunyikan spinner setelah jeda selesai
                    setTimeout(function () {
                        $btnSpinner.hide();
                    }, 500);
                });
        }, 500);
    }

    // ====================================================================
    // EVENT HANDLER UNTUK KLIK PADA LINK PAGINASI
    // ====================================================================
    // Gunakan event delegation karena link paginasi dibuat secara dinamis
    $(document).on('click', '#sesi-pagination-container .pagination a', function (e) {
        e.preventDefault(); // Mencegah browser berpindah halaman

        const href = $(this).attr('href');
        const url = new URL(href);
        const page = url.searchParams.get('page'); // Ambil nomor halaman dari URL link

        if (page) {
            loadPerangkat(page); // Panggil kembali fungsi loadPerangkat dengan halaman baru
            // Scroll ke atas list (opsional, tapi baik untuk UX)
            $('html, body').animate({
                scrollTop: $sesiListContainer.offset().top - 20
            }, 500);
        }
    });

    /**
     * Event handler untuk tombol "Logout Perangkat Lain".
     */
    $sesiForm.on('submit', function (e) {
        e.preventDefault();

        Swal.fire({
            title: 'Konfirmasi',
            text: 'Keluar dari semua perangkat lain?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33'
        }).then((result) => {
            if (result.isConfirmed) {
                // Atur tombol ke status loading
                $btnHapusSesi.prop('disabled', true);
                $btnSpinner.show();
                $btnText.text('Memproses...');

                $.ajax({
                    url: $urlLogoutPerangkat,
                    type: 'POST',
                    dataType: 'json',
                })
                    .done(function (res) {
                        if (res.status === 'success') {
                            Swal.fire('Berhasil!', res.message, 'success').then(() => {
                                // 5. INI BAGIAN PENTINGNYA: Panggil lagi fungsi loadPerangkat
                                // untuk me-refresh daftar sesi tanpa reload halaman.
                                Beranda.refreshCsrf();
                                loadPerangkat();
                            });
                        } else {
                            Swal.fire(res.status === 'info' ? 'Info' : 'Gagal', res.message, res.status);
                        }
                    })
                    .fail(function () {
                        Swal.fire("Error", "Terjadi kesalahan saat menghubungi server.", "error");
                    })
                    .always(function () {
                        // Kembalikan kondisi tombol jika tidak berhasil
                        // (Jika berhasil, akan di-handle oleh loadPerangkat)
                        $btnSpinner.hide();
                        $btnText.text('Logout Perangkat Lain');
                        // Kondisi disabled akan diatur ulang oleh loadPerangkat()
                    });
            }
        });
    });

    /** 
     * Jika isPemilikProfil bernilai true,
     * maka fungsi loadPerangkat() akan dipanggil
    */
    if (isPemilikProfil) {
        loadPerangkat(1);
    }

    /**
     * Fungsi utilitas untuk escape HTML
     * @param {*} text 
     * @returns 
     */
    function escapeHtml(text) {
        if (typeof text !== 'string') return '';
        var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
});

function cekpwd() {
    if ($(".passwd").get(0).type === "password") {
        $(".ikon").html("<i class='bi bi-eye-slash'></i>");
        $("#password, #password_confirm").each(function () {
            this.type = "text";
        });
    } else {
        $(".ikon").html("<i class='bi bi-eye'></i>");
        $("#password, #password_confirm").each(function () {
            this.type = "password";
        });
    }
}

let $akunForm = $('#akun-form'),
    $akunSubmit = $('#akun-submit'),
    $akunLoading = $('#akun-loading');

let $infoForm = $('#info-form'),
    $infoSubmit = $('#info-submit'),
    $infoLoading = $('#info-loading');

$(function () {
    $('[data-toggle="tooltip"]').tooltip()
    $akunLoading.hide();
    $infoLoading.hide();
});

// Form simpan tab akun
$(function () {
    let formCekAkun = FormHelper.cekFormData($akunForm);
    $akunForm.validate($.extend(FormHelper.validasiForm(), {
        rules: {
            username: { required: true, minlength: 3, maxlength: 30 },
            email: { required: true, customEmail: true },
            password: { required: false, minlength: 8 },
            password_confirm: { required: false, equalTo: '#password' }
        },
        submitHandler: (form) => {
            $akunForm.find(':input').removeClass('is-invalid is-valid');
            if (!formCekAkun.isChanged()) return false;
            return FormHelper.submitForm(form, $urlAkun, $akunSubmit, $akunLoading, {formCek: formCekAkun});
        }
    }));
});

// Form simpan tab info
$(function () {
    let formCekInfo = FormHelper.cekFormData($infoForm);
    $infoForm.validate($.extend(FormHelper.validasiForm(), {
        rules: {
            perusahaan: { required: false, minlength: 5, maxlength: 30 },
            whatsapp: { required: false, digits: true, minlength: 8, maxlength: 15 },
            telegram: { required: false, digits: true, minlength: 8, maxlength: 15 },
            alamat: { required: false, minlength: 10, maxlength: 100 }
        },
        submitHandler: (form) => {
            $infoForm.find(':input').removeClass('is-invalid is-valid');
            if (!formCekInfo.isChanged()) return false;
            return FormHelper.submitForm(form, $urlInfo, $infoSubmit, $infoLoading, {formCek: formCekInfo});
        }
    }));
});