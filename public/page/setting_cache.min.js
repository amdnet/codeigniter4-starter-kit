/*!
 * CirebonWeb (https://cirebonweb.com)
 * Copyright (c) 2023 CirebonWeb
 * Licensed under MIT (https://opensource.org/licenses/MIT)
 */

let baseUrl = window.location.href;
window.Lokasi = {
    urlSimpan: `${baseUrl}/simpan`,
    urlTabel: `${baseUrl}/tabel`,
    urlHapus: `${baseUrl}/hapus`
};

/**
 * Inisialisasi DataTable
*/
const $tabelData = $('#tabel-data');
TabelHelper.tabelDinamis($tabelData, Lokasi.urlTabel, [
    {
        extend: 'excelHtml5', text: 'Excel',
        exportOptions: { columns: ':visible:not(:eq(6))' }
    }
],
    [
        { targets: 0, width: '5%' },
        { targets: [0, 7], className: 'dt-body-center' },
        { targets: [3, 4], className: 'dt-body-right' },
        { targets: '_all', className: 'dt-head-center' },
        { targets: [3, 4, 5, 6, 7], orderable: false },
        { targets: [0, 3, 4, 5, 6, 7], searchable: false },
    ],
    [[0, 'asc']], {
    initComplete: function () {
        let api = this.api();
        let filterContainer = $('#tabel-data_filter');
        let extraFilters = $('<div class="ml-2 d-inline-block"></div>');

        api.columns([1, 2]).every(function () {
            let column = this;
            let headerText = $(column.header()).text().trim();
            let select = $('<select class="form-control form-control-sm d-inline-block w-auto mr-1"><option value="">Semua ' + headerText + '</option></select>')
                .appendTo(extraFilters)
                .on('change', function () {
                    let val = $.fn.dataTable.util.escapeRegex($(this).val());
                    column.search(val ? '^' + val + '$' : '', true, false).draw();
                });

            column.data().unique().sort().each(function (d) {
                // Bersihkan HTML sebelum dimasukkan ke dropdown
                let text = $('<div>').html(d).text().trim();
                select.append('<option value="' + text + '">' + text + '</option>');
            });
        });

        filterContainer.append(extraFilters);
    }
});

/**
 * Form setting durasi cache
 */
$(function () {
    let $formId = $('#cache-form'),
        $btnSubmit = $('#cache-submit'),
        $btnLoading = $('#cache-loading');

    $btnLoading.hide();

    let formCek = FormHelper.cekFormData($formId);

    $formId.validate($.extend(FormHelper.validasiForm(), {
        ignore: [],
        rules: {
            cache_geoip: { required: true },
            cache_device: { required: true },
            statistik_user_list: { required: true },
            statistik_user_login: { required: true }
        },
        submitHandler: function (form) {
            $formId.find(':input').removeClass('is-invalid is-valid');
            if (!formCek.isChanged()) return false;
            return FormHelper.submitForm(form, Lokasi.urlSimpan, $btnSubmit, $btnLoading, {formCek: formCek});
        }
    }));
});

/**
 * Hapus file cache
 */
$(document).on('click', '.btn-delete', function (e) {
    e.preventDefault();
    let filename = $(this).data('filename');

    Swal.fire({
        title: 'Konfirmasi',
        text: "Hapus file: " + filename,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: Lokasi.urlHapus,
                type: 'POST',
                data: { filename: filename },
                dataType: 'json',
                success: function (res) {
                    if (res.success) {
                        Swal.fire('Berhasil', res.messages, 'success').then(() => {
                            $tabelData.DataTable().ajax.reload(null, false);
                        });
                    } else {
                        Swal.fire('Error', res.messages, 'error');
                    }
                },
                error: function (xhr) {
                    let msg =
                        xhr.responseJSON?.messages ||
                        xhr.responseText || 'Terjadi kesalahan...';
                    Swal.fire('Error', msg, 'error');
                }
            });
        }
    });
});